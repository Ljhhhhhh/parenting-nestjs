## AI 育儿助手 - 后端开发计划 V1.0

**目标:** 指导 AI 育儿助手后端服务的开发过程，确保按时、高质量地交付符合设计要求的功能。本计划基于已确定的技术架构（NestJS Boilerplate + Prisma + LangChain.js 等）。
**参考文档:** AI 育儿助手后端架构方案 (ID: `nestjs_boilerplate_architecture_v1`)
**假设:**

- 开发团队具备 NestJS、TypeScript、Prisma、Docker 和 Git 的基本使用经验。
- 团队成员可以访问必要的资源，如 OpenAI API 密钥、数据库实例、Redis 实例等。
- 采用敏捷开发模式，每个 Sprint 周期为 2 周。
- 项目管理工具（如 Jira, Trello）和代码托管平台（如 GitHub, GitLab）已准备就绪。

### 开发阶段与任务分解

**Phase 0: 环境搭建与基础设置 (Sprint 0 - 约 1 周)**

- **目标:** 准备好开发环境，搭建项目骨架，配置基础服务和工具。
- **任务:**
  - [ ] **T0.1:** 初始化 Git 仓库，设置分支策略（如 Gitflow）。
  - [ ] **T0.2:** 克隆选定的 NestJS Boilerplate (`nestjs-prisma-starter`) 到仓库。
  - [ ] **T0.3:** 配置 `.env` 文件和 `ConfigModule`，加载基础环境变量（数据库、Redis、端口等）。
  - [ ] **T0.4:** 本地搭建 PostgreSQL 数据库实例。
  - [ ] **T0.5:** 配置 `PrismaModule`，连接数据库，运行 Boilerplate 自带的或初始的 `schema.prisma` 迁移 (`npx prisma migrate dev`)。
  - [ ] **T0.6:** 本地搭建 Redis 实例。
  - [ ] **T0.7:** 配置 `CacheModule` (连接 Redis)。
  - [ ] **T0.8:** 配置 `LoggerModule` (Pino) 实现结构化日志基础。
  - [ ] **T0.9:** 配置 `HealthModule` 提供基础健康检查端点 (`/health`)。
  - [ ] **T0.10:** 配置基础 CI 流水线：安装依赖、代码风格检查 (Lint)、运行 Boilerplate 自带的初始测试。
- **产出:** 可运行的基础 NestJS 应用骨架，连接数据库和 Redis，具备基础日志和健康检查，CI 流水线初步建立。

**Phase 1: 核心用户与儿童管理 (Sprint 1 - 2 周)**

- **目标:** 实现用户认证授权和儿童信息管理的核心功能。
- **任务:**
  - [ ] **T1.1:** 实现 `AuthModule`：
    - [ ] 用户注册 (Email/Password, 密码使用 Argon2 哈希)。
    - [ ] 用户登录 (验证密码, 签发 JWT Access Token 和 Refresh Token)。
    - [ ] Token 刷新接口。
    - [ ] 获取当前用户信息接口 (`/auth/me`)。
  - [ ] **T1.2:** 实现 `AuthGuard` (JWT 策略)，并应用于需要认证的接口。
  - [ ] **T1.3:** 实现 `ChildrenModule`：
    - [ ] 添加儿童信息接口 (`POST /children`)。
    - [ ] 获取当前用户所有儿童列表接口 (`GET /children`)。
    - [ ] 获取指定儿童信息接口 (`GET /children/{id}`)。
    - [ ] 更新儿童信息接口 (`PUT/PATCH /children/{id}`)。
    - [ ] 删除儿童信息接口 (`DELETE /children/{id}`)。
  - [ ] **T1.4:** 完善 `schema.prisma`：定义 `User` 和 `Child` 模型，**特别注意 `Child` 模型中的 `allergy_info` 字段，建议使用 `Json` 类型存储结构化过敏原列表** (例如 `String[]` 或 `Allergen[]` 结构)。运行数据库迁移。
  - [ ] **T1.5:** 编写 `AuthModule` 和 `ChildrenModule` 的单元测试 (Unit Tests) 和集成测试 (Integration Tests)。
  - [ ] **T1.6:** 配置 Swagger (`@nestjs/swagger`)，为已实现的 API 生成文档。
- **产出:** 可靠的用户注册、登录、认证功能；完整的儿童信息管理 API；相应的测试用例；初步的 API 文档。
- **依赖:** T0 完成。

**Phase 2: 日常记录管理 (Sprint 2 - 2 周)**

- **目标:** 实现灵活的日常记录功能。
- **任务:**
  - [ ] **T2.1:** 实现 `RecordsModule`：
    - [ ] 添加记录接口 (`POST /children/{child_id}/records`)，DTO 中包含 `record_type`, `record_timestamp`, `details` (JSONB)。
    - [ ] 获取指定儿童记录列表接口 (`GET /children/{child_id}/records`)，支持分页、按时间范围 (`start_ts`, `end_ts`) 和记录类型 (`record_type`) 过滤。
    - [ ] 删除单条记录接口 (`DELETE /records/{record_id}`)，注意权限校验。
  - [ ] **T2.2:** 完善 `schema.prisma`：定义 `Record` 模型，`details` 字段使用 `Json` 类型。考虑为 `child_id` 和 `record_timestamp` 添加复合索引。运行数据库迁移。
  - [ ] **T2.3:** 在 `RecordsModule` 的 DTO 中，使用 `class-validator` 和 `class-transformer`，根据 `record_type` 对 `details` JSON 字段进行条件验证（或使用 Zod/Joi 辅助）。
  - [ ] **T2.4:** 编写 `RecordsModule` 的单元测试和集成测试，覆盖不同记录类型和查询过滤条件。
  - [ ] **T2.5:** 更新 Swagger 文档。
- **产出:** 完整的日常记录管理 API；灵活的记录存储和查询能力；相应的测试用例；更新的 API 文档。
- **依赖:** T1 完成。

**Phase 3: AI 集成 - 核心聊天功能 (Sprint 3 & 4 - 4 周)**

- **目标:** 集成 LangChain.js，实现具备上下文感知和基础安全检查的 AI 聊天核心流程。
- **Sprint 3 任务:**
  - [ ] **T3.1:** 创建 `LangChainModule` (参考架构文档 8.1)，配置 `ChatOpenAI` Provider，从 `ConfigModule` 读取 API Key 等配置。
  - [ ] **T3.2:** 创建 `AIModule` 和 `ChatModule` 的基本结构。
  - [ ] **T3.3:** 实现 `ContextBuilder` 服务 (在 `AIModule` 内)：
    - [ ] 注入 `PrismaService` (或 `ChildrenService`/`RecordsService`)。
    - [ ] 实现根据 `childId` 获取儿童信息（含结构化的 `allergy_info`）和近期记录的逻辑。
    - [ ] 实现将获取的信息格式化为文本上下文 (`contextText`) 的逻辑。
    - [ ] 返回 `contextText` 和结构化的 `allergyInfo`。
  - [ ] **T3.4:** 设计并实现初步的 System Prompt (包含角色定义、目标、基础安全指令)。
  - [ ] **T3.5:** 实现 `SafetyChecker` 服务 (在 `AIModule` 内)：
    - [ ] 实现**严格的过敏原检测**逻辑，基于结构化的 `allergyInfo` 对 LLM 响应进行检查。检测到则替换为安全提示。
    - [ ] 实现基础的医疗建议关键词检测逻辑。
    - [ ] 实现强制附加免责声明的逻辑。
  - [ ] **T3.6:** 在 `AIService` 中，使用 LCEL 组装核心的 `RunnableSequence`，串联 `ContextBuilder` -> Prompt -> `ChatOpenAI` -> `SafetyChecker`。
  - [ ] **T3.7:** 实现 `ChatModule` 的核心聊天接口 (`POST /api/v1/chat`)，调用 `AIService.getAiReply`。
  - [ ] **T3.8:** 定义 `ChatHistory` 模型 (`schema.prisma`)，包含 `userId`, `childId`, `userMessage`, `aiResponse` (最终回复), `rawAiResponse` (原始回复), `contextSummary` (上下文摘要), `safetyFlags`, `requestTimestamp`, `responseTimestamp`, `feedback`。运行数据库迁移。
  - [ ] **T3.9:** 实现 `ChatHistoryRepository` 或在 `ChatService` 中实现保存聊天记录的逻辑。
  - [ ] **T3.10:** 编写 `AIModule` 和 `ChatModule` 的单元测试（重点 Mock LLM 调用，测试上下文构建和安全检查）和集成测试（测试完整流程，可能需要 Mock LLM API Key 或使用测试 Key）。
- **Sprint 4 任务:**
  - [ ] **T3.11:** 调优 System Prompt 和上下文构建逻辑，提高回复相关性和安全性。
  - [ ] **T3.12:** 增强 `SafetyChecker` 的健壮性，测试更多过敏原和医疗相关的边缘情况。
  - [ ] **T3.13:** 实现聊天反馈接口 (`POST /api/v1/chats/{chat_id}/feedback`)，更新 `ChatHistory` 中的 `feedback` 字段。
  - [ ] **T3.14:** 实现获取指定儿童聊天历史记录的接口 (`GET /api/v1/children/{child_id}/chats`)，支持分页。
  - [ ] **T3.15:** 补充和完善 AI 相关功能的测试用例。
  - [ ] **T3.16:** 更新 Swagger 文档。
- **产出:** 可用的 AI 聊天接口；具备上下文感知和基础安全检查能力；聊天记录存储、查询和反馈功能；相应的测试用例；更新的 API 文档。
- **依赖:** T2 完成。

**Phase 4: 跨领域关注点与打磨 (Sprint 5 - 2 周)**

- **目标:** 完善系统的非功能性需求，提升健壮性和安全性。
- **任务:**
  - [ ] **T4.1:** 实现全局异常过滤器 (`ExceptionFilter`)，统一处理和格式化错误响应。
  - [ ] **T4.2:** 实现请求/响应日志拦截器 (`LoggingInterceptor`, `ResponseInterceptor`)，记录关键信息（脱敏）。
  - [ ] **T4.3:** 配置并应用速率限制 (`ThrottlerGuard`) 到关键 API 端点（如登录、注册、聊天）。
  - [ ] **T4.4:** 全面审查和增强安全性：
    - [ ] 确保所有输入都经过 DTO 验证 (`ValidationPipe`)。
    - [ ] 检查并确保没有敏感信息泄露。
    - [ ] 集成 `helmet` 中间件设置安全头。
  - [ ] **T4.5:** (可选) 集成基础监控指标 (`@nestjs/terminus` 或 `prom-client`)，暴露 `/metrics` 端点。
  - [ ] **T4.6:** (可选) 实现一个简单的后台任务示例，使用 `QueueModule` (BullMQ)，例如发送模拟通知。
  - [ ] **T4.7:** 编写端到端 (E2E) 测试，覆盖主要用户流程（注册 -> 登录 -> 添加儿童 -> 添加记录 -> AI 聊天）。
  - [ ] **T4.8:** 进行代码审查 (Code Review) 和必要的代码重构。
- **产出:** 更健壮、安全的后端服务；完善的日志、错误处理和限流机制；主要的 E2E 测试覆盖；(可选) 基础监控和队列示例。
- **依赖:** T3 完成。

**Phase 5: 部署准备与文档定稿 (Sprint 6 - 1 周)**

- **目标:** 完成部署前的准备工作和最终文档。
- **任务:**
  - [ ] **T5.1:** 最终审查和完善所有 API 的 Swagger 文档。
  - [ ] **T5.2:** 编写 `Dockerfile` 用于构建应用镜像。
  - [ ] **T5.3:** 完善 CI/CD 流水线，增加构建 Docker 镜像的步骤。
  - [ ] **T5.4:** (可选) 配置将镜像推送到镜像仓库（如 Docker Hub, AWS ECR, Google GCR）的 CI/CD 步骤。
  - [ ] **T5.5:** (可选) 编写基础的部署脚本或 K8s manifest 文件 (或 Helm Chart) 用于部署到测试/生产环境。
  - [ ] **T5.6:** 编写部署操作手册或 README 文档，说明如何配置和启动服务。
  - [ ] **T5.7:** 进行最终的功能测试和回归测试，修复发现的 Bug。
- **产出:** 可部署的应用 Docker 镜像；完善的 API 文档和部署说明；最终测试通过的版本。
- **依赖:** T4 完成。

### 里程碑 (Milestones)

- **M1 (Sprint 1 结束):** 核心用户认证和儿童管理功能完成。
- **M2 (Sprint 2 结束):** 日常记录管理功能完成。
- **M3 (Sprint 4 结束):** 核心 AI 聊天功能完成并经过初步测试。
- **M4 (Sprint 5 结束):** 系统健壮性和安全性得到加强，主要流程 E2E 测试通过。
- **M5 (Sprint 6 结束):** 项目达到可部署状态，文档齐全。

### 工具建议

- **项目管理:** Jira, Trello, Asana, Monday.com
- **代码托管:** GitHub, GitLab, Bitbucket
- **API 测试:** Postman, Insomnia

### 风险与缓解措施

1. **AI 安全风险 (过敏原/医疗建议):**

   - **风险:** `SafetyChecker` 可能无法 100% 拦截所有不安全内容。
   - **缓解:**
     - **结构化过敏信息 (已强调)。**
     - **严格的 `SafetyChecker` 实现和测试。**
     - **持续优化 Prompt 安全指令。**
     - **清晰的用户端免责声明和风险提示。**
     - **上线后持续监控和人工抽查。**

2. **第三方 API 依赖 (OpenAI):**

   - **风险:** API 不可用、性能波动、成本超预期。
   - **缓解:**
     - **实现合理的重试机制和超时设置。**
     - **监控 API 调用延迟和成本。**
     - **设计 Plan B (例如，暂时降级为无 AI 功能或使用备用模型)。**

3. **数据隐私与合规:**

   - **风险:** 处理儿童敏感信息，可能违反隐私法规。
   - **缓解:**
     - **最小化数据收集。**
     - **脱敏处理日志和存储。**
     - **严格的访问控制。**
     - **了解并遵守相关法规 (如 GDPR, CCPA, PIPL)。**

4. **范围蔓延:**

   - **风险:** 开发过程中不断增加新功能，导致延期。
   - **缓解:**

     - **严格遵守 MVP (最小可行产品) 范围。**
     - **新需求进入 Backlog，按优先级排期。**
     - **加强项目管理和沟通。**

本计划提供了一个详细的路线图，但实际执行中可能需要根据具体情况进行调整。请确保团队成员充分理解任务和目标，并保持良好的沟通。
