# AI 育儿助手 - 后端开发计划 V1.0

**目标:** 指导 AI 育儿助手后端服务的开发过程，确保按时、高质量地交付符合设计要求的功能。本计划基于已确定的技术架构（NestJS Boilerplate + Prisma + LangChain.js 等）。
**参考文档:** AI 育儿助手后端架构方案 (ID: `nestjs_boilerplate_architecture_v1`)
**假设:**

- 开发团队具备 NestJS、TypeScript、Prisma、Docker 和 Git 的基本使用经验。
- 团队成员可以访问必要的资源，如 OpenAI API 密钥、数据库实例、Redis 实例等。
- 采用敏捷开发模式，每个 Sprint 周期为 2 周。
- 项目管理工具（如 Jira, Trello）和代码托管平台（如 GitHub, GitLab）已准备就绪。

## 开发阶段与任务分解

#### Phase 0: 环境搭建与基础设置 (Sprint 0 - 约 1 周)

- **目标:** 准备好开发环境，搭建项目骨架，配置基础服务和工具。
- **任务:**
  - [ ] **T0.1:** 初始化 Git 仓库，设置分支策略（如 Gitflow）。
  - [ ] **T0.2:** 克隆选定的 NestJS Boilerplate (`nestjs-prisma-starter`) 到仓库。
  - [ ] **T0.3:** 配置 `.env` 文件和 `ConfigModule`，加载基础环境变量（数据库、Redis、端口等）。
  - [ ] **T0.4:** 本地搭建 PostgreSQL 数据库实例。
  - [ ] **T0.5:** 配置 `PrismaModule`，连接数据库，运行 Boilerplate 自带的或初始的 `schema.prisma` 迁移 (`npx prisma migrate dev`)。
  - [ ] **T0.6:** 本地搭建 Redis 实例。
  - [ ] **T0.7:** 配置 `CacheModule` (连接 Redis)。
  - [ ] **T0.8:** 配置 `LoggerModule` (Pino) 实现结构化日志基础。
  - [ ] **T0.9:** 配置 `HealthModule` 提供基础健康检查端点 (`/health`)。
  - [ ] **T0.10:** 配置基础 CI 流水线：安装依赖、代码风格检查 (Lint)、运行 Boilerplate 自带的初始测试。
- **产出:** 可运行的基础 NestJS 应用骨架，连接数据库和 Redis，具备基础日志和健康检查，CI 流水线初步建立。

#### Phase 1: 核心用户与儿童管理 (Sprint 1 - 2 周)

- **目标:** 实现用户认证授权和儿童信息管理的核心功能。
- **任务:**
  - [ ] **T1.1:** 实现 `AuthModule`：
    - [ ] 用户注册 (Email/Password, 密码使用 Argon2 哈希)。
    - [ ] 用户登录 (验证密码, 签发 JWT Access Token 和 Refresh Token)。
    - [ ] Token 刷新接口。
    - [ ] 获取当前用户信息接口 (`/auth/me`)。
  - [ ] **T1.2:** 实现 `AuthGuard` (JWT 策略)，并应用于需要认证的接口。
  - [ ] **T1.3:** 实现 `ChildrenModule`：
    - [ ] 添加儿童信息接口 (`POST /children`)。
    - [ ] 获取当前用户所有儿童列表接口 (`GET /children`)。
    - [ ] 获取指定儿童信息接口 (`GET /children/{id}`)。
    - [ ] 更新儿童信息接口 (`PUT/PATCH /children/{id}`)。
    - [ ] 删除儿童信息接口 (`DELETE /children/{id}`)。
  - [ ] **T1.4:** 完善 `schema.prisma`：定义 `User` 和 `Child` 模型，**特别注意 `Child` 模型中的 `allergy_info` 字段，建议使用 `Json` 类型存储结构化过敏原列表** (例如 `String[]` 或 `Allergen[]` 结构)。运行数据库迁移。
  - [ ] **T1.5:** 编写 `AuthModule` 和 `ChildrenModule` 的单元测试 (Unit Tests) 和集成测试 (Integration Tests)。
  - [ ] **T1.6:** 配置 Swagger (`@nestjs/swagger`)，为已实现的 API 生成文档。
- **产出:** 可靠的用户注册、登录、认证功能；完整的儿童信息管理 API；相应的测试用例；初步的 API 文档。
- **依赖:** T0 完成。

#### Phase 2: 日常记录管理 (Sprint 2 - 2 周)

- **目标:** 实现灵活的日常记录功能。
- **任务:**
  - [ ] **T2.1:** 实现 `RecordsModule`：
    - [ ] 添加记录接口 (`POST /children/{child_id}/records`)，DTO 中包含 `record_type`, `record_timestamp`, `details` (JSONB)。
    - [ ] 获取指定儿童记录列表接口 (`GET /children/{child_id}/records`)，支持分页、按时间范围 (`start_ts`, `end_ts`) 和记录类型 (`record_type`) 过滤。
    - [ ] 删除单条记录接口 (`DELETE /records/{record_id}`)，注意权限校验。
  - [ ] **T2.2:** 完善 `schema.prisma`：定义 `Record` 模型，`details` 字段使用 `Json` 类型。考虑为 `child_id` 和 `record_timestamp` 添加复合索引。运行数据库迁移。
  - [ ] **T2.3:** 在 `RecordsModule` 的 DTO 中，使用 `class-validator` 和 `class-transformer`，根据 `record_type` 对 `details` JSON 字段进行条件验证（或使用 Zod/Joi 辅助）。
  - [ ] **T2.4:** 编写 `RecordsModule` 的单元测试和集成测试，覆盖不同记录类型和查询过滤条件。
  - [ ] **T2.5:** 更新 Swagger 文档。
- **产出:** 完整的日常记录管理 API；灵活的记录存储和查询能力；相应的测试用例；更新的 API 文档。
- **依赖:** T1 完成。

#### Phase 3: AI 集成 - 核心聊天功能 (Sprint 3 & 4 - 4 周)

- **目标:** 集成 LangChain.js，实现基于儿童档案和日常信息的个性化 AI 聊天功能，确保安全性和亲切性。
- **Sprint 3 任务:**
  - [ ] **T3.1:** 创建 `LangchainModule`，配置 `ChatOpenAI` Provider：
    - [ ] 安装必要的依赖 (`langchain`, `@langchain/openai`, `@langchain/core`)。
    - [ ] 实现 `LangchainModule` 和 `LangchainService`，从 `ConfigModule` 读取 API 密钥。
    - [ ] 配置 `ChatOpenAI` 实例，设置适当的模型参数（如 `gpt-4o`, `temperature: 0.7`）。
  - [ ] **T3.2:** 创建 `AIModule` 和 `ChatModule` 的基本结构：
    - [ ] 设计模块目录结构（controllers, services, DTOs, entities, checkers 等）。
    - [ ] 定义基础接口和类型。
  - [ ] **T3.3:** 实现 `ContextFactory` 服务：
    - [ ] 注入 `UsersService`, `ChildrenService`, `RecordsService`, `ChatService`。
    - [ ] 实现 `buildContext(userId: string, childId?: string)` 方法，获取用户和儿童信息。
    - [ ] 获取儿童基本信息（月龄、性别、过敏信息）和近期相关记录。
    - [ ] 获取最近的聊天记录，提供对话连续性。
    - [ ] 实现月龄计算和记录格式化辅助方法。
  - [ ] **T3.4:** 设计并实现安全检查器：
    - [ ] 实现 `AllergyChecker`，检测回复中是否含有可能引起过敏的建议。
    - [ ] 实现 `MedicalChecker`，检测回复中是否包含医疗建议。
    - [ ] 创建过敏物关键词映射表，扩展检查范围。
  - [ ] **T3.5:** 实现 `AIService` 核心服务：
    - [ ] 注入 `LangchainService`, `ContextFactory` 和安全检查器。
    - [ ] 实现 `generateAnswer` 方法，协调整个 AI 回答生成流程。
    - [ ] 实现 `buildChatMessages` 方法，构建包含系统提示、上下文和用户问题的消息数组。
    - [ ] 实现 `performSafetyChecks` 方法，对 LLM 回复进行安全检查。
    - [ ] 实现 `getAgeSpecificGuidance` 方法，根据月龄提供特定指南。
  - [ ] **T3.6:** 实现 `ChatModule` 的核心聊天接口：
    - [ ] 创建 `ChatRequestDto` 和 `ChatResponseDto`。
    - [ ] 实现 `POST /api/v1/chat` 接口，调用 `AIService.generateAnswer`。
    - [ ] 应用 `AuthGuard('jwt')` 确保接口安全。
  - [ ] **T3.7:** 定义 `ChatHistory` 模型 (`schema.prisma`)：
    - [ ] 包含 `userId`, `childId`, `userMessage`, `aiResponse`, `rawAiResponse`, `contextSummary`, `safetyFlags`, `userFeedback`, `createdAt`, `updatedAt` 字段。
    - [ ] 建立与 `User` 和 `Child` 模型的关联。
    - [ ] 运行数据库迁移。
  - [ ] **T3.8:** 实现 `ChatService` 保存聊天记录的逻辑：
    - [ ] 创建 `create` 方法，保存完整的聊天记录。
    - [ ] 实现 `findRecentByUserId` 方法，获取用户最近的聊天记录。
    - [ ] 实现 `countByUserId` 方法，用于判断是否为新用户。
  - [ ] **T3.9:** 编写单元测试：
    - [ ] 测试 `ContextFactory` 的上下文构建逻辑。
    - [ ] 测试 `AllergyChecker` 和 `MedicalChecker` 的检测逻辑。
    - [ ] 测试 `AIService` 的消息构建和安全检查流程。
  - [ ] **T3.10:** 实现问题建议功能：
    - [ ] 在 `AIService` 中实现 `getQuestionSuggestions` 方法。
    - [ ] 为新用户提供基础引导问题。
    - [ ] 根据儿童月龄提供个性化问题建议。
    - [ ] 创建 `GET /api/v1/suggestions` 接口，支持可选的 `childId` 参数。
  - [ ] **T3.11:** 增强安全检查机制：
    - [ ] 扩充过敏物关键词映射表。
    - [ ] 完善医疗建议检测逻辑，增加强医疗指示词。
    - [ ] 测试更多边缘情况，确保检测的准确性。
  - [ ] **T3.12:** 优化提示模板：
    - [ ] 调整系统提示，使回答更加亲切温暖。
    - [ ] 完善月龄特定指南，增强回答的针对性。
    - [ ] 优化上下文整合逻辑，确保信息的相关性和完整性。
  - [ ] **T3.13:** 实现聊天反馈功能：
    - [ ] 创建 `AiFeedbackDto`，包含 `chatHistoryId` 和 `isHelpful` 字段。
    - [ ] 实现 `POST /api/v1/feedback` 接口，保存用户反馈。
    - [ ] 在 `ChatService` 中实现 `saveFeedback` 方法。
  - [ ] **T3.14:** 实现聊天历史查询功能：
    - [ ] 实现 `GET /api/v1/children/{child_id}/chats` 接口，支持分页。
    - [ ] 在 `ChatService` 中实现相应的查询方法。
  - [ ] **T3.15:** 编写集成测试：
    - [ ] 测试完整的聊天流程，从请求到响应。
    - [ ] 测试聊天历史的存储和查询。
    - [ ] 测试问题建议和反馈功能。
  - [ ] **T3.16:** 更新 Swagger 文档：
    - [ ] 为所有 AI 相关接口添加详细的 API 文档。
    - [ ] 使用 `@ApiTags`, `@ApiOperation`, `@ApiResponse` 等装饰器。
- **产出:** 基于儿童档案和日常信息的个性化 AI 聊天功能；严格的安全检查机制；聊天历史存储和查询功能；问题建议和反馈功能；完整的测试覆盖；详细的 API 文档。
- **依赖:** T2 完成。

#### Phase 4: 跨领域关注点与打磨 (Sprint 5 - 2 周)

- **目标:** 完善系统的非功能性需求，提升健壮性、安全性和用户体验。
- **任务:**
  - [ ] **T4.1:** 实现全局异常处理：
    - [ ] 创建全局异常过滤器 (`ExceptionFilter`)，统一处理和格式化错误响应。
    - [ ] 定义标准错误响应格式，包含错误码、消息和详情。
    - [ ] 为不同类型的异常（如验证错误、权限错误、资源不存在等）设计特定的处理逻辑。
  - [ ] **T4.2:** 增强日志系统：
    - [ ] 实现请求/响应日志拦截器 (`LoggingInterceptor`)，记录请求路径、方法、状态码和响应时间。
    - [ ] 确保敏感信息（如密码、Token、过敏信息）在日志中被脱敏处理。
    - [ ] 为 AI 交互添加详细日志，记录上下文摘要、安全检查结果和响应时间。
  - [ ] **T4.3:** 实现 API 限流保护：
    - [ ] 配置 `ThrottlerModule` 和 `ThrottlerGuard`。
    - [ ] 为关键 API 端点（如登录、注册、AI 聊天）设置合理的限流规则。
    - [ ] 自定义限流响应，提供友好的错误信息。
  - [ ] **T4.4:** 增强 AI 服务的性能和可靠性：
    - [ ] 为 LLM 调用添加超时设置和重试机制（使用 `withRetry()` 和 `timeout()`）。
    - [ ] 优化上下文构建，控制 Token 使用量。
    - [ ] 实现缓存机制，对频繁请求的相似问题提供快速响应。
  - [ ] **T4.5:** 全面安全审查：
    - [ ] 确保所有输入都经过 `ValidationPipe` 验证，启用 `whitelist` 和 `transform` 选项。
    - [ ] 检查并确保没有敏感信息泄露。
    - [ ] 集成 `helmet` 中间件设置安全头。
    - [ ] 审查权限控制，确保用户只能访问自己的数据。
  - [ ] **T4.6:** 优化用户体验：
    - [ ] 完善错误消息，使其更加用户友好。
    - [ ] 优化 API 响应格式，保持一致性。
    - [ ] 为长时间运行的操作提供状态反馈。
  - [ ] **T4.7:** 实现端到端测试：
    - [ ] 使用 Jest 和 Supertest 编写 E2E 测试。
    - [ ] 覆盖主要用户流程（注册 -> 登录 -> 添加儿童 -> 添加记录 -> AI 聊天）。
    - [ ] 测试边缘情况和错误处理。
  - [ ] **T4.8:** 代码质量提升：
    - [ ] 进行全面代码审查。
    - [ ] 重构重复或复杂的代码。
    - [ ] 确保代码符合项目的风格指南。
    - [ ] 完善代码注释和文档字符串。
  - [ ] **T4.9:** (可选) 监控与可观测性：
    - [ ] 集成 `@nestjs/terminus` 提供健康检查端点。
    - [ ] 使用 `prom-client` 暴露关键指标（如请求数、响应时间、错误率）。
    - [ ] 设置基础的监控仪表板。
  - [ ] **T4.10:** (可选) 后台任务处理：
    - [ ] 集成 `BullMQ` 和 `@nestjs/bull`。
    - [ ] 实现示例任务，如定期数据清理或统计生成。
- **产出:** 健壮、安全、高性能的后端服务；完善的错误处理、日志和限流机制；优化的 AI 服务体验；全面的 E2E 测试覆盖；高质量的代码库。
- **依赖:** T3 完成。

#### Phase 5: 部署准备与文档定稿 (Sprint 6 - 1 周)

- **目标:** 完成部署前的准备工作和最终文档。
- **任务:**
  - [ ] **T5.1:** 最终审查和完善所有 API 的 Swagger 文档。
  - [ ] **T5.2:** 编写 `Dockerfile` 用于构建应用镜像。
  - [ ] **T5.3:** 完善 CI/CD 流水线，增加构建 Docker 镜像的步骤。
  - [ ] **T5.4:** (可选) 配置将镜像推送到镜像仓库（如 Docker Hub, AWS ECR, Google GCR）的 CI/CD 步骤。
  - [ ] **T5.5:** (可选) 编写基础的部署脚本或 K8s manifest 文件 (或 Helm Chart) 用于部署到测试/生产环境。
  - [ ] **T5.6:** 编写部署操作手册或 README 文档，说明如何配置和启动服务。
  - [ ] **T5.7:** 进行最终的功能测试和回归测试，修复发现的 Bug。
- **产出:** 可部署的应用 Docker 镜像；完善的 API 文档和部署说明；最终测试通过的版本。
- **依赖:** T4 完成。

## 里程碑 (Milestones)

- **M1 (Sprint 1 结束):** 核心用户认证和儿童管理功能完成。
- **M2 (Sprint 2 结束):** 日常记录管理功能完成。
- **M3 (Sprint 4 结束):** 核心 AI 聊天功能完成并经过初步测试。
- **M4 (Sprint 5 结束):** 系统健壮性和安全性得到加强，主要流程 E2E 测试通过。
- **M5 (Sprint 6 结束):** 项目达到可部署状态，文档齐全。

## 工具建议

- **项目管理:** Jira, Trello, Asana, Monday.com
- **代码托管:** GitHub, GitLab, Bitbucket
- **API 测试:** Postman, Insomnia

## 风险与缓解措施

#### AI 安全风险 (过敏原/医疗建议):

- **风险:** `SafetyChecker` 可能无法 100% 拦截所有不安全内容。
- **缓解:**
  - **结构化过敏信息 (已强调)。**
  - **严格的 `SafetyChecker` 实现和测试。**
  - **持续优化 Prompt 安全指令。**
  - **清晰的用户端免责声明和风险提示。**
  - **上线后持续监控和人工抽查。**

#### 第三方 API 依赖 (OpenAI):

- **风险:** API 不可用、性能波动、成本超预期。
- **缓解:**
  - **实现合理的重试机制和超时设置。**
  - **监控 API 调用延迟和成本。**
  - **设计 Plan B (例如，暂时降级为无 AI 功能或使用备用模型)。**

#### 数据隐私与合规:

- **风险:** 处理儿童敏感信息，可能违反隐私法规。
- **缓解:**
  - **最小化数据收集。**
  - **脱敏处理日志和存储。**
  - **严格的访问控制。**
  - **了解并遵守相关法规 (如 GDPR, CCPA, PIPL)。**

#### 范围蔓延:

- **风险:** 开发过程中不断增加新功能，导致延期。
- **缓解:**

  - **严格遵守 MVP (最小可行产品) 范围。**
  - **新需求进入 Backlog，按优先级排期。**
  - **加强项目管理和沟通。**

本计划提供了一个详细的路线图，但实际执行中可能需要根据具体情况进行调整。请确保团队成员充分理解任务和目标，并保持良好的沟通。
